<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Forum&family=Pixelify+Sans:wght@400..700&display=swap" rel="stylesheet"><meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Meu Amor - Game</title>
    <style>
      body {
        margin: 0;
        background: #222;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>
    <script>
    // =============================
    // SCENE 1 - Start
    // =============================
    class StartScene extends Phaser.Scene {
      constructor() {
        super('StartScene');
      }

      create() {
        const titleText = this.add.text(400, 250, "Oi, meu amor,", {
          fontFamily: 'Pixelify Sans',
          fontWeight: '700',
          fontSize: '20px',
          color: "#ffffff",
          align: "center"
        }).setOrigin(0.5);

        const pressStartText = this.add.text(400, 350, "Pressione a BARRA DE ESPAÇO", {
          fontFamily: 'Pixelify Sans',
          fontSize: "20px",
          color: "#ffffff",
          align: "center"
        }).setOrigin(0.5);

        // Blink effect
        this.tweens.add({
          targets: pressStartText,
          alpha: 0,
          duration: 800,
          yoyo: true,
          repeat: -1
        });

        // Space to go to next scene
        this.input.keyboard.on('keydown-SPACE', () => {
          this.scene.start('RickMortyScene');
        });
      }
    }


    // =============================
    // RickMortyScene (StartScene)
    // Jogador anda até a direita, entra no portal e vai para CenaPreta
    // =============================
    class RickMortyScene extends Phaser.Scene {
      constructor() {
        super('RickMortyScene');
        this.blockHit = false;
        this.mushroomCollected = false;
      }

      create() {
        this.physics.world.setBounds(0, 0, 800, 600);
        this.physics.world.gravity.y = 500;

        // Chão
        const ground = this.add.rectangle(400, 590, 800, 20, 0x654321);
        this.physics.add.existing(ground, true);

        // Jogador
        this.player = this.add.rectangle(100, 500, 30, 50, 0xff0000);
        this.physics.add.existing(this.player);
        this.player.body.setCollideWorldBounds(true);
        this.physics.add.collider(this.player, ground);

        // Yellow Block
        this.block = this.add.rectangle(400, 400, 32, 32, 0xFFFF00);
        this.physics.add.existing(this.block, true);
        this.physics.add.collider(this.player, this.block, this.hitBlock, null, this);

        // Mushroom (initially hidden)
        this.mushroom = this.add.rectangle(400, 368, 20, 20, 0x00FF00);
        this.physics.add.existing(this.mushroom);
        this.mushroom.visible = false;
        this.mushroom.body.setAllowGravity(false);

        // Portal (initially hidden)
        this.portal = this.add.rectangle(750, 500, 50, 100, 0x00FFFF);
        this.physics.add.existing(this.portal, true);
        this.portal.visible = false;

        // Collider for the mushroom and ground
        this.physics.add.collider(this.mushroom, ground);
        this.physics.add.overlap(this.player, this.mushroom, this.collectMushroom, null, this);

        // Overlap for the portal
        this.physics.add.overlap(this.player, this.portal, this.enterPortal, null, this);

        // Input keys
        this.cursors = this.input.keyboard.createCursorKeys();

        // Instructions
        this.infoText = this.add.text(400, 100, 
          "Bata de cabeça no bloco amarelo para liberar o cogumelo!\nUse as setas para mover, Espaço para pular.", 
          { font: "16px Arial", fill: "#ffffff", align: "center" }
        ).setOrigin(0.5);
      }

      update() {
        const speed = 160;

        // Horizontal movement
        if (this.cursors.left.isDown) {
          this.player.body.setVelocityX(-speed);
        } else if (this.cursors.right.isDown) {
          this.player.body.setVelocityX(speed);
        } else {
          this.player.body.setVelocityX(0);
        }

        // Jump if on the ground
        if ((this.cursors.up.isDown || this.cursors.space.isDown) && this.player.body.blocked.down) {
          this.player.body.setVelocityY(-400);
        }
      }

      hitBlock(player, block) {
        // Check if hitting from below
        if (!this.blockHit && player.body.touching.up) {
          this.blockHit = true;
          
          // Show the mushroom
          this.mushroom.visible = true;
          this.mushroom.body.setAllowGravity(true);
        }
      }

      collectMushroom(player, mushroom) {
        if (!this.mushroomCollected) {
          this.mushroomCollected = true;
          mushroom.destroy();

          // Show the portal after the mushroom is collected
          this.portal.visible = true;
        }
      }

      enterPortal(player, portal) {
        // When the player touches the portal, go to the next scene
        this.scene.start('RickMortyMessage');
      }
    }


    // =============================
    // RickMortyMessage
    // Tela preta, aperte G duas vezes para continuar
    // =============================
    class RickMortyMessage extends Phaser.Scene {
      constructor() {
        super('RickMortyMessage');
        this.gCount = 0;
      }

      create() {
        this.cameras.main.setBackgroundColor('#000000');
        this.add.text(400, 300, "Tela preta: Pressione G duas vezes para continuar",
          { font: "20px Arial", fill: "#ffffff", align: "center"}).setOrigin(0.5);

        this.gKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.G);
      }

      update() {
        if (Phaser.Input.Keyboard.JustDown(this.gKey)) {
          this.gCount++;
          if (this.gCount >= 2) {
            this.scene.start('TimeBreakScene');
          }
        }
      }
    }

    // =============================
    // TimeBreakScene
    // Jogador sai de um portal, encontra Rick, Morty e um inimigo.
    // Mata o inimigo pulando na cabeça. Ao morrer, o inimigo explode,
    // divide a tela em 10 partes. Após 2s, volta ao normal, sobra só jogador, Rick e Morty.
    // =============================
    class TimeBreakScene extends Phaser.Scene { 
      constructor() {
        super('TimeBreakScene');
        this.enemyDead = false;
        this.hasGun = false;
      }

      preload() {
        // Create a small white bullet texture
        const bulletCanvas = this.textures.createCanvas('bullet', 2, 2);
        bulletCanvas.context.fillStyle = '#ffffff';
        bulletCanvas.context.fillRect(0,0,2,2);
        bulletCanvas.refresh();
      }

      create() {
        // Physics world
        this.physics.world.setBounds(0, 0, 800, 600);
        this.physics.world.gravity.y = 500;

        // Ground
        this.ground = this.add.rectangle(400, 590, 800, 20, 0x654321);
        this.physics.add.existing(this.ground, true);

        // Player
        this.player = this.add.rectangle(100, 500, 30, 50, 0xff0000);
        this.physics.add.existing(this.player);
        this.player.body.setCollideWorldBounds(true);
        this.physics.add.collider(this.player, this.ground);

        // Enemy
        this.enemy = this.add.rectangle(600, 500, 30, 50, 0xff00ff);
        this.physics.add.existing(this.enemy);
        this.enemy.body.setCollideWorldBounds(true);
        this.physics.add.collider(this.enemy, this.ground);

        // Gun spawn
        this.gunSpawnX = 700; 
        this.gunSpawnY = 550;
        this.addGun(this.ground);

        // Bullets
        this.bullets = this.physics.add.group({ allowGravity: false });

        // Overlaps
        this.physics.add.overlap(this.bullets, this.enemy, this.shootEnemy, null, this);
        this.physics.add.overlap(this.player, this.enemy, this.enemyHitPlayer, null, this);

        // Input
        this.cursors = this.input.keyboard.createCursorKeys();
        this.shootKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);

        // Respawn point
        this.spawnPoint = { x: 100, y: 500 };
      }

      update() {
        const speed = 160;

        // Movement
        if (this.cursors.left.isDown) {
          this.player.body.setVelocityX(-speed);
        } else if (this.cursors.right.isDown) {
          this.player.body.setVelocityX(speed);
        } else {
          this.player.body.setVelocityX(0);
        }

        // Jump
        if (this.cursors.up.isDown && this.player.body.blocked.down) {
          this.player.body.setVelocityY(-400);
        }

        // Shoot
        if (this.hasGun && Phaser.Input.Keyboard.JustDown(this.shootKey)) {
          this.shootBullet();
        }

        // Enemy follow
        if (!this.enemyDead) {
          if (this.player.x < this.enemy.x) {
            this.enemy.body.setVelocityX(-100);
          } else {
            this.enemy.body.setVelocityX(100);
          }
        }
      }

      addGun(ground) {
        // Add the gun back at original position
        this.gun = this.add.rectangle(this.gunSpawnX, this.gunSpawnY, 20, 10, 0xffff00);
        this.physics.add.existing(this.gun);
        this.physics.add.collider(this.gun, ground);
        this.physics.add.overlap(this.player, this.gun, this.collectGun, null, this);
      }

      collectGun(player, gun) {
        this.hasGun = true;
        gun.destroy();
        this.add.text(400, 100, "You got the gun! Press SPACE to shoot.", { font: "16px Arial", fill: "#ffffff" }).setOrigin(0.5);
      }

      shootBullet() {
        const bullet = this.bullets.create(this.player.x + 20, this.player.y, 'bullet');
        bullet.setDisplaySize(10, 5);
        bullet.body.setVelocityX(400);
      }

      shootEnemy(bullet, enemy) {
        bullet.destroy();
        this.killEnemy();
      }

      enemyHitPlayer(player, enemy) {
        if (!this.enemyDead) {
          // Player loses the gun on death
          this.hasGun = false;
          this.respawnPlayer();

          // Re-add the gun after losing it
          this.addGun(this.ground);
        }
      }

      respawnPlayer() {
        this.player.setPosition(this.spawnPoint.x, this.spawnPoint.y);
        this.player.body.setVelocity(0);
      }

      killEnemy() {
        if (this.enemyDead) return;
        this.enemyDead = true;
        this.enemy.destroy();

        // Create a 4x5 grid of cameras, all showing the entire scene
        const rows = 4;
        const cols = 5;
        const camWidth = 800 / cols;
        const camHeight = 600 / rows;

        const zoomFactor = 0.2;

        for (let row = 0; row < rows; row++) {
          for (let col = 0; col < cols; col++) {
            const cam = this.cameras.add(col * camWidth, row * camHeight, camWidth, camHeight);
            // Center the camera on the scene center (400,300) and zoom out
            cam.setScroll(400, 300); // center of the scene
            cam.setZoom(zoomFactor);
          }
        }
        this.cameras.main.setVisible(false);

        
      }
    }


    // =============================
    // GAME CONFIG
    // =============================
    const config = {
      type: Phaser.AUTO,
      width: 800,
      height: 600,
      backgroundColor: "#000000",
      scene: [
        StartScene, RickMortyScene, RickMortyMessage, TimeBreakScene 
        ],
      physics: {
        default: 'arcade',
        arcade: { debug: false }
      }
    };

    new Phaser.Game(config);
    </script>
  </head>
<body>
</body>
</html>
